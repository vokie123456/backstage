<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="{$Think.ADMIN_PATH}css/bootstrap.min.css">
    <link rel="stylesheet" href="{$Think.ADMIN_PATH}js/layui/css/layui.css">
    <link rel="stylesheet" href="{$Think.ADMIN_PATH}css/biaoge.css">
    <script src="{$Think.ADMIN_PATH}js/jquery-3.3.1.min.js"></script>
    <script src="{$Think.ADMIN_PATH}js/layui/layui.js"></script>
    <script src="{$Think.ADMIN_PATH}js/main.js"></script>
    <script src="{$Think.ADMIN_PATH}js/wlz.js"></script>
    <title>添加私信</title>
    <style>
        .container-fluid {
            border: solid 1px rgb(210, 210, 210);
            border-radius: 5px;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        html {
            width: 100%;
            height: 100%;
        }

        body {
            height: 100%;
            width: 100%;
            padding: 10px;
        }

        .warpbox {
            margin: 0px auto;
            /* width: 80%; */
            /* padding: 0px 20px; */
        }

        .biaoti {
            text-align: right;
            height: 100%;
            line-height: 34px;
        }

        .tiaobox {
            /* height: 34px; */
            margin: 20px 0px;
        }
        .col-md-8{
            line-height: 31px;
        }

        .col-md-8 input[type=radio]{
            top: 5px;
        }
        #shaixuan div{
            padding: 15px;
        }


        @media (max-width: 991px){

         }
        @media (max-width: 767px){
            .warpbox{
                margin: 0px;
                padding: 0px;
                width: 100%;
            }
            .biaoti{
                text-align: left;
            }
            .col-xs-12{
                margin: 5px;
            }
         }
         #submit{
             margin: 20px;
         }
         .shanchu{
             margin-left: 0px !important;
         }
         .pad{
             padding: 10px 30px;
         }
    </style>
</head>

<body>
    <div class="container-fluid">
        <form class="warpbox">
                <div class="row tiaobox">
                    <div class="col-md-2 col-sm-2 col-xs-12 biaoti">
                        接收内容 :
                    </div>
                    <div class="col-md-10 col-sm-10 col-xs-12 pad">
                        <textarea class="form-control" rows="6" name="neirong"></textarea>
                    </div>
                </div>

            <div class="row tiaobox">
                <div class="col-md-2 col-sm-2 col-xs-12 biaoti">
                    接收人员 :
                </div>
                <div class="col-md-10 col-sm-10 col-xs-12">
                        <div action="" id="shaixuan" class="form-inline" id="tiaojian">
                            <div class="col-md-5 col-sm-5 col-xs-12">
                                <input type="text"  class="form-control"  placeholder="会员名称" name="input" id="sou">
                                <button type="button" class="btn btn-primary" id="search_btn1">搜索</button>
                            </div>
                            <div class="col-md-5 col-sm-5 col-xs-12 col-md-offset-2 col-sm-offset-2">
                                <input type="text"  class="form-control"  placeholder="会员名称" name="input" id="sou2">
                                <button type="button" class="btn btn-primary" id="search_btn2">搜索</button>
                            </div>
                        </div>
                        <div class="col-md-5 col-sm-5 col-xs-12">

                                <div class="table-responsive box">
                                    <table class="table table-bordered table-hover" id="box1">
                                        <thead>
                                            <tr>
                                                <th>
                                                    <input type="checkbox" tou='tou1' id="tou1" >
                                                </th>
                                                <th>ID</th>
                                                <th>接收人</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tes">
                                            <tr>
                                                <td>
                                                    <input type="checkbox" tr-id=1 value="id1" >
                                                </td>
                                                <td>客服A</td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <input type="checkbox" tr-id=2 value="id2">
                                                </td>
                                                <td>客服A</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div id="test1"></div>
                        </div>
                        <div class="col-md-2 col-sm-2 col-xs-12">
                            <button type="button" class="layui-btn layui-btn-xs tianjia">添加</button>
                            <button type="button" class="layui-btn layui-btn-xs red shanchu">删除</button>
                        </div>
                        <div class="col-md-5 col-sm-5 col-xs-12">
                                <div class="table-responsive box">
                                    <table class="table table-bordered table-hover" id="box2">
                                        <thead>
                                            <tr>
                                                <th>
                                                    <input type="checkbox" tou = 'tou2' id="tou2">
                                                </th>
                                                <th>ID</th>
                                                <th>接收人</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tes2">
                                            <tr>
                                                <td>
                                                    <input type="checkbox" value="id3">
                                                </td>
                                                <td>客服A</td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <input type="checkbox" value="id4">
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div id="test2"></div>
                        </div>
                </div>
            </div>


        </form>
        <div class="row tiaobox">
            <div class="col-md-12 col-sm-12 col-xs-12 text-center">
                <button class="btn btn-default" id="submit" type="button">提交</button>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function () {

            var arr = [];   //全选搜索 重置为空再合并
            var x = 2;
            var arr1 = [];
            var arr2 = [];
            var crr1 = [];
            var crr2 = [];  //点击搜索 重置为空
            var result1={type:'all',arr};       //box1条件
            var result2={type:'only',arr};       //box2条件
            var sou = false;
            var sou2 = false;
            function checkAll({ box } = {}) {
                box.forEach(element => {

                    var th = element + ' th input[type = checkbox]';
                    var td = element + ' td input[type = checkbox]';
                    var boolean = $(th).is(':checked');
                    if (boolean) {

                        $(td).prop("checked", true);
                        var brr = [...new Set(arr1.concat(arr2))];
                            console.log(arr1)
                        brr.forEach(function (ele) {
                            $('input[value = '+ele+']').prop("checked",false);
                        })

                    } else {
                        $(td).prop("checked", false);
                        var brr = [...new Set(crr1.concat(crr2))];
                        brr.forEach(function (ele) {
                            $('input[value = '+ele+']').prop("checked",true);
                        })
                    }
                    //
                    // 监听全选事件
                    $(th).change(function () {
                        var boolean = $(th).is(':checked');
                        if (boolean) {
                            $(td).prop("checked", true);

                        } else {
                            $(td).prop("checked", false);
                        }
                    });
                });
            }


            function condition() {




                // 重置数组
                $('th input[type = checkbox]').change(function () {
                    if($(this).is(':checked')){
                        // 改变到全选
                        if($(this).attr('tou') === 'tou1'){
                            arr1 = [];
                        }else{
                            arr2 = [];
                        }
                    }else{
                        // 改变到非全选
                        if($(this).attr('tou') === 'tou1'){
                            crr1 = [];
                        }else{
                            crr2 = [];
                        }
                    }
                });

                $(document).on("change", "td input[type = checkbox]", function(){
                    //此处的$(this)指$( "#testDiv")，而非$(document)
                    var boxId = $(this).parent().parent().parent().parent()[0].id;
                    var thBol = $('#'+boxId+' th input[type = checkbox]').is(':checked');
                    var value = $(this).val();
                    // console.log(thBol)
                    // 非搜索状态下的变化

                    if(thBol){
                        // 全选状态下  arr1和arr2的改变
                        if(boxId==='box1' && !sou)
                        {
                            var index = arr1.indexOf(value);
                            index !== -1 ? arr1.splice(index,1):arr1.push(value);
                            arr1 = [...new Set(arr1)];

                        }else if(boxId==='box2' && !sou2){
                            var index = arr2.indexOf(value);
                            index !== -1 ? arr2.splice(index,1):arr2.push(value);
                            arr2 = [...new Set(arr2)];
                        }
                    }else{
                        // 非全选状态下  crr1和crr2的改变
                        if(boxId==='box1' && !sou){
                            var index = crr1.indexOf(value);
                            index !== -1 ? crr1.splice(index,1):crr1.push(value);
                            crr1 = [...new Set(crr1)];
                        }else if(boxId==='box2' && !sou2){
                            var index = crr2.indexOf(value);
                            index !== -1 ? crr2.splice(index,1):crr2.push(value);
                            crr2 = [...new Set(crr2)];
                        }
                    }
                    console.log(arr2);
                    // console.log(arr2);
                });
                // td改变数组元素
                // $('td input[type = checkbox]').change(function () {
                //     var boxId = $(this).parent().parent().parent().parent()[0].id;
                //     var thBol = $('#'+boxId+' th input[type = checkbox]').is(':checked');
                //     var value = $(this).val();
                //     // console.log(thBol)
                //     // 非搜索状态下的变化
                //
                //     if(thBol){
                //         // 全选状态下  arr1和arr2的改变
                //         if(boxId==='box1' && !sou)
                //         {
                //             var index = arr1.indexOf(value);
                //             index !== -1 ? arr1.splice(index,1):arr1.push(value);
                //             arr1 = [...new Set(arr1)];
                //
                //         }else if(boxId==='box2' && !sou2){
                //             var index = arr2.indexOf(value);
                //             index !== -1 ? arr2.splice(index,1):arr2.push(value);
                //             arr2 = [...new Set(arr2)];
                //         }
                //     }else{
                //         // 非全选状态下  crr1和crr2的改变
                //         if(boxId==='box1' && !sou){
                //             var index = crr1.indexOf(value);
                //             index !== -1 ? crr1.splice(index,1):crr1.push(value);
                //             crr1 = [...new Set(crr1)];
                //         }else if(boxId==='box2' && !sou2){
                //             var index = crr2.indexOf(value);
                //             index !== -1 ? crr2.splice(index,1):crr2.push(value);
                //             crr2 = [...new Set(crr2)];
                //         }
                //     }
                //     console.log(arr1);
                //     console.log(arr2);
                // })
                // 点击搜索改变sou sou2
                $('#search_btn1,#search_btn2').click(function () {
                    console.log(result1);
                    var bol = $(this)[0].id === 'search_btn1';
                    if(bol){

                        $('#sou').val()===''?sou=false:sou=true;
                        crr1 = [];//点击搜索重置数组
                        result1.inputvalue = $('#sou').val();
                        console.log(result1);
                        demo(url, xr, undefined, undefined, result1);

                    }else{
                        $('#sou2').val()===''?sou2=false:sou2=true;
                        crr2 = [];//点击搜索重置数组
                        result2.inputvalue = $('#sou2').val();
                        console.log(result2);
                        demo2(url, xr2, undefined, undefined, result2);
                    }

                })
                $('.tianjia,.shanchu').click(function () {

                    //全选且没有搜索条件
                    var box;
                    $(this).html()==='添加'?box = 1:box = 2;
                    var bol1 = $('#tou1').is(':checked');
                    var bol2 = $('#tou2').is(':checked');
                    if(box===1 && !sou && bol1){
                        //点击添加 且 没有搜索  且全选
                        //全选条件下arr重置为[];

                        arr = [];
                        arr = [...new Set(arr.concat(arr1))];
                        arr1= []; //点击后重置arr1
                        $('#tou1').prop("checked",false);
                        x = 1;
                        //-------------------------发送请求  只要arr    除了arr    点击添加(全选)
                        result1 = {type:'only',arr};
                        result2 = {type:'all',arr}
                        demo(url, xr, undefined, undefined, result1);
                        demo2(url, xr2, undefined, undefined, result2);

                    }else if(box===2 && !sou2 && bol2){
                        //点击删除 且 没有搜索  且全选
                        //全选条件下arr重置为[];


                        arr = [];
                        arr = [...new Set(arr.concat(arr2))];
                        arr2= []; //点击后重置arr1
                        $('#tou2').prop("checked",false);
                        x = 2;
                        //-------------------------发送请求 只要arr    除了arr      点击删除(全选)
                        result2 = {type:'only',arr};
                        result1 = {type:'all',arr}
                        demo(url, xr, undefined, undefined, result1);
                        demo2(url, xr2, undefined, undefined, result2);

                    }
                    // 非全选 且 没有搜索条件 x = 1
                    if(box===1 && !sou && !bol1 && x === 2){
                        arr = [...new Set(arr.concat(crr1))];  //合并
                        crr1 = [];//重置
                        // -------------------------发送请求 除了arr     只要arr     点击添加(非全选)(不在这边)
                        result1 = {type:'all',arr};
                        result2 = {type:'only',arr}
                        demo(url, xr, undefined, undefined, result1);
                        demo2(url, xr2, undefined, undefined, result2);

                    }else if(box===2 && !sou2 && !bol1 && x === 1){
                        arr = [...new Set(arr.concat(crr2))];  //合并
                        crr2 = [];//重置
                        // -------------------------发送请求 除了arr     只要arr     点击删除(非全选)(不在这边)
                        result2 = {type:'all',arr};
                        result1 = {type:'only',arr};
                        demo(url, xr, undefined, undefined, result1);
                        demo2(url, xr2, undefined, undefined, result2);

                    }
                    if(box===1 && !sou && !bol1 && x === 1){
                        crr1.forEach(ele => {
                            var index = arr.indexOf(ele);
                            arr.splice(index,1);
                        });
                        crr1 = [];//重置
                        // -------------------------发送请求  只要 arr    除了 arr   点击添加(非全选)(在这边)
                        result1 = {type:'only',arr};
                        result2 = {type:'all',arr};
                        demo(url, xr, undefined, undefined, result1);
                        demo2(url, xr2, undefined, undefined, result2);

                    }else if(box===2 && !sou2 && !bol1 && x === 2){
                        crr2.forEach(ele => {
                            var index = arr.indexOf(ele);
                            arr.splice(index,1);
                        });
                        crr2 = [];//重置
                        // -------------------------发送请求  只要 arr    除了 arr   点击删除(非全选)(在这边)
                        result2 = {type:'only',arr};
                        result1 = {type:'all',arr}
                        demo(url, xr, undefined, undefined, result1);
                        demo2(url, xr2, undefined, undefined, result2);

                    }
                    //搜索条件

                    if(box===1 && sou  && x === 2){

                        var ele = $('#box1 td input[type = checkbox]')[0];
                        if($(ele).is(':checked')){
                            crr1.push(ele.value);
                        }else{
                            crr1= [];
                        }
                        arr = [...new Set(arr.concat(crr1))];  //合并
                        crr1 = [];
                        sou = false; //重置
                        //-------------------------发送请求  除了arr     只要arr     点击添加(搜索)(不在这边)
                        result1 = {type:'all',arr};
                        result2 = {type:'only',arr}
                        demo(url, xr, undefined, undefined, result1);
                        demo2(url, xr2, undefined, undefined, result2);

                    }else if(box===2 && sou2  && x === 1){
                        var ele = $('#box2 td input[type = checkbox]')[0];

                        if($(ele).is(':checked')){
                            crr2.push(ele.value);
                        }else{
                            crr2= [];
                        }
                        arr = [...new Set(arr.concat(crr2))];  //合并
                        crr2 = [];
                        sou2 = false; //重置
                        // ------------------------发送请求 除了arr   只要 arr    点击删除(搜索)(不在这边)
                        result2 = {type:'all',arr};
                        result1 = {type:'only',arr}
                        demo(url, xr, undefined, undefined, result1);
                        demo2(url, xr2, undefined, undefined, result2);

                    }

                    if(box===1 && sou  && x === 1){
                        var ele = $('#box1 td input[type = checkbox]')[0];
                        if($(ele).is(':checked')){
                            crr1.push(ele.value);
                        }else{
                            crr1= [];
                        }
                        var index = arr.indexOf(crr1);
                            if(index !== -1){
                                arr.splice(index,1);
                            }
                            sou = false; //重置
                        //--------------------------发送请求  只要arr     除了 arr 点击添加(搜索)(在这边)
                        result2 = {type:'all',arr};
                        result1 = {type:'only',arr}
                        demo(url, xr, undefined, undefined, result1);
                        demo2(url, xr2, undefined, undefined, result2);

                            crr1 = [];

                    }else if(box===2 && sou2  && x === 2){
                        var ele = $('#box2 td input[type = checkbox]')[0];
                        if($(ele).is(':checked')){
                            crr2.push(ele.value);
                        }else{
                            crr2= [];
                        }
                        var index = arr.indexOf(crr2);
                            if(index !== -1){
                                arr.splice(index,1);
                            }
                            sou2 = false; //重置
                        // ---------------------------发送请求  只要arr   除了 arr 点击删除(搜索)(在这边)
                        result1 = {type:'all',arr};
                        result2 = {type:'only',arr}
                        demo(url, xr, undefined, undefined, result1);
                        demo2(url, xr2, undefined, undefined, result2);

                        crr2 = [];
                    }

                    console.log(result1);
                    console.log(arr);

                })

            }
            condition();










            // 删除操作
            // $('.shanchu').click(function () {

            // });
            // 后台请求地址
            var url = "{:url('privateletter/getUserData')}";
            // 初始化弹框
            layui.use(['form', 'laydate', 'laypage', 'layer'], function () {
                var laydate = layui.laydate;
                laypage = layui.laypage
                    , layer = layui.layer;

                // 页面加载请求数据，及传入渲染函数
                demo(url, xr, undefined, undefined, result1);  //第一次渲染数据
                demo2(url, xr2, undefined, undefined, result2); //第一次渲染数据
            });




            // 渲染拼接方法
            function xr(res) {

                // 再这里渲染
                var html = "";
                var end = res['list'].length;
                for (var i = 0; i < end; i++) {
                    html += "<tr>";
                    html += "<td><input type='checkbox' tr-id="+res['list'][i]['id']+" value="+res['list'][i]['id']+" ></td>";
                    html += "<td>" + res['list'][i]['id'] + "</td>";
                    html += "<td>" + res['list'][i]['username'] + "</td>";
                    html += "</tr>";
                }
                $('#tes').html(html);
                checkAll({box:['#box1','#box2']});

            }
            function xr2(res) {
                // 再这里渲染
                var html = "";
                var end = res['list'].length;
                for (var i = 0; i < end; i++) {
                    html += "<tr>";
                    html += "<td><input type='checkbox' tr-id="+res['list'][i]['id']+" value="+res['list'][i]['id']+" ></td>";
                    html += "<td>" + res['list'][i]['id'] + "</td>";
                    html += "<td>" + res['list'][i]['username'] + "</td>";

                    html += "</tr>";
                }
                $('#tes2').html(html);
                checkAll({box:['#box1','#box2']});
            }

            $('#submit').click(function(){
                var this_ = this;
                var text = $('textarea').val();
                var postUrl = '';

                $.post(postUrl,{content:text,param:result2},function(result){
                    if(data['status'] ==1){
                       layer.msg(data['msg']);
                       setTimeout(function(){
                           var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                           parent.layer.close(index); //再执行关闭
                       },1000);

                   }else{
                       layer.msg(data['msg']);
                       setTimeout(function(){
                           $(this_).removeClass("layui-btn-disabled");
                           $(this_).attr("disabled",false);
                       },1000);

                   }
                });
            });

        });
    </script>

</body>

</html>
